module.exports = function filter(o, rules){
	var err = {};
	var new_o = {};
	for (var key in rules) {
		if (typeof o[key] !== 'undefined') {
			if (o[key] instanceof Array && rules[key] instanceof Array) {
				new_o[key] = rules[key].filter(function(v){
					return o[key].filter(function(uv){return uv === v});
				});
			} else if (rules[key] instanceof RegExp) {
				if (rules[key].test(o[key])) {
					new_o[key] = o[key];
				} else {
					err[key] = "invalid value";
				}
			}else if (typeof rules[key] == 'function') {
				new_o[key] = rules[key](o[key]);
			} else if (typeof o[key] == 'object' && typeof rules[key] == 'object') {
				try {
					new_o[key] = _filter(o[key], rules[key]);
				} catch(e) {
					err[key] = e;
				}
			}
		}
	};
	if (Object.keys(err).length != 0 ) throw err;
	return new_o;
};
